---
- name: Deploy Stack
  hosts: all
  become: false
  gather_facts: false
  vars:
    known_hosts: |
      devbox.robert.local,192.168.1.42 ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBIpDg+z8B5AWiJF89PRzSppCE3aW8czN+8GE9Cc8vOJ9JK2fut9of62+Zz+7cqtWz2KXnRdQbrJymIkdYoQY8Wc=
    id_rsa: !vault |
      $ANSIBLE_VAULT;1.1;AES256
      38666539653431373639613935323362303438373664636363393564313663356263356164396265
      6364306534383365313331313233303762613034323234630a343661303631623731333636356531
      31663264643337346636643364393263306235663537343166336330616538626535393733373738
      6363343336336561610a353039363135623839616162656230646233316430373233366130646362
      33623864343237363739666663623231363933383763316166383466326434653136653636323665
      38373936653263396334343932633030633332643838666139636437626663313263663338643836
      30326136353965323639653965633336633465616661613134366532333266363634653266623633
      62346433633138333264636236646465646631343861643164643666633338373766303665323265
      34356663353434373431646162636131623662643536353664366537383162636264363931646433
      36326330616465646563653937363361313436643739306565363533616134316265613462373333
      32666332336261646662636238333733393635343463346163313339633961363061383263636635
      65343133373430616665663736646333326435633337313966366232663233386664633864313066
      65653931303666643332303266383138393063386336316162613633343634333130663330626337
      33393263373263636639663364666363363662633561376134653634303330646364346531643639
      64643133633139666433663464613639333064393531376338333666656236346638326166666338
      65653533356132316365333765333138303531336266306639643333646138363366373931303064
      61373031316338663534356364323734363536343931386665383265643766313964346639656637
      32313737373038663561303366623637373235303836393639643166633635303064333762383230
      36636130303663366563383561353535313632613664333430353136633334363165303339613936
      34366234666635316132363162626437643332613338313433383465386430613131343666623239
      36653730363030646639633164613464653766303338623461633630396330383332336538656230
      31313361663066623934333434303337633831633066623539663034353663343066616363316465
      34316136613066613234616535653938663065353966366533323236346562303162393263356131
      34373837353033623965613361653662346363393833623662326565616538653764303935643531
      3933
  tasks:

    - name: create .ssh directory
      ansible.builtin.file:
        path: $HOME/.ssh
        state: directory
        mode: 0755
      delegate_to: localhost

    - name: Create file id_rsa
      ansible.builtin.copy:
        dest: $HOME/.ssh/id_rsa.pub
        content: "{{ id_rsa }}"
        mode: 0644
      delegate_to: localhost

    - name: Ensure ssh host key known
      ansible.builtin.copy:
        dest: $HOME/.ssh/known_hosts
        content: "{{ known_hosts }}"
        mode: 0600
      delegate_to: localhost

    - name: Deploy VM
      community.general.terraform:
        project_path: './'
        state: present
        force_init: true
      delegate_to: localhost

    - name: Store tfstate
      ansible.builtin.copy:
        src: terraform.tfstate
        dest: ~/terraform.tfstate
        mode: 0644
